from pathlib import Path

import pandas as pd

from mecfs_bio.build_system.asset.base_asset import Asset
from mecfs_bio.build_system.asset.directory_asset import DirectoryAsset
from mecfs_bio.build_system.asset.file_asset import FileAsset
from mecfs_bio.build_system.meta.asset_id import AssetId
from mecfs_bio.build_system.meta.read_spec.dataframe_read_spec import (
    DataFrameReadSpec,
    DataFrameTextFormat,
)
from mecfs_bio.build_system.meta.simple_directory_meta import SimpleDirectoryMeta
from mecfs_bio.build_system.meta.simple_file_meta import SimpleFileMeta
from mecfs_bio.build_system.task.fake_task import FakeTask
from mecfs_bio.build_system.task.gwaslab.sldsc_scatter_plot_task import (
    SLDSCScatterPlotTask,
)
from mecfs_bio.build_system.wf.base_wf import SimpleWF

_dummy_data = {
    "Name": {
        0: "T.4Mem.Sp",
        1: "NKT.4+.Lv",
        2: "NKT.4-.Sp",
        3: "T.4Mem44h62l.Sp",
        4: "LN.TR.14w.B6",
        5: "ABD.TR.14w.B6",
        6: "NKT.4-.Lv",
        7: "T.4Mem44h62l.LN",
        8: "CD4Control",
        9: "T.4FP3+25+.Sp",
        10: "T.8Eff.Sp.OT1.d10.LisOva",
        11: "Tgd.vg2-.Sp",
        12: "T.8Eff.Sp.OT1.d8.VSVOva",
        13: "NKT.44+NK1.1+.Th",
        14: "Tgd.vg2-.act.Sp",
        15: "Tgd.vg2+.Sp",
        16: "NKT.4+.Sp",
        17: "NK.b2m-.Sp",
        18: "T.4.Pa.BDC",
        19: "T.4Mem.LN",
        20: "T.8Eff.Sp.OT1.d8.LisOva",
        21: "T.4SP69+.Th",
        22: "Tgd.vg2+24alo.Th",
        23: "Tgd.vg2-.Sp.TCRbko",
        24: "Tgd.vg2+24ahi.Th",
        25: "T.8Mem.Sp.OT1.d45.LisOva",
        26: "T.8Mem.Sp.OT1.d45.VSVOva",
        27: "T.8Eff.Sp.OT1.d15.VSVOva",
        28: "T.8Mem.Sp",
    },
    "Coefficient": {
        0: 1.7544136618079722e-08,
        1: 1.4500521532013905e-08,
        2: 1.6115815705680808e-08,
        3: 1.516409974310819e-08,
        4: 1.4606955696862205e-08,
        5: 1.6197558097696537e-08,
        6: 1.3121475235991626e-08,
        7: 1.3798373173254444e-08,
        8: 1.3649417618800073e-08,
        9: 1.1074509095790333e-08,
        10: 1.0740065208885313e-08,
        11: 9.08136572725004e-09,
        12: 1.0852426863903036e-08,
        13: 1.0989619378628481e-08,
        14: 8.33485528452417e-09,
        15: 1.0773598027929836e-08,
        16: 1.1553979401329736e-08,
        17: 8.964217139596644e-09,
        18: 1.0029697227722337e-08,
        19: 9.515013560538524e-09,
        20: 9.750097727252111e-09,
        21: 1.0160096107208628e-08,
        22: 1.2728910011213104e-08,
        23: 8.780361830258283e-09,
        24: 1.0982934322541226e-08,
        25: 1.0130244219630042e-08,
        26: 9.865573129598312e-09,
        27: 7.909586042235061e-09,
        28: 1.0702196255680924e-08,
    },
    "Coefficient_std_error": {
        0: 3.4780410348301714e-09,
        1: 2.9716982436570027e-09,
        2: 3.416444594112964e-09,
        3: 3.263651350115502e-09,
        4: 3.229611840580637e-09,
        5: 3.6427601650670477e-09,
        6: 3.0199632386506963e-09,
        7: 3.2793063039653103e-09,
        8: 3.5231360921211132e-09,
        9: 3.0287987209937994e-09,
        10: 3.0043073449471887e-09,
        11: 2.5976292433414414e-09,
        12: 3.106619216041882e-09,
        13: 3.210703451650174e-09,
        14: 2.443561951822859e-09,
        15: 3.2082303029004673e-09,
        16: 3.4897617055381805e-09,
        17: 2.7685861359536872e-09,
        18: 3.1247120021919652e-09,
        19: 2.981402824641366e-09,
        20: 3.084392642702553e-09,
        21: 3.215622741222346e-09,
        22: 4.045173483256398e-09,
        23: 2.8279915117093044e-09,
        24: 3.5587582737928446e-09,
        25: 3.314844819167141e-09,
        26: 3.3384972057264994e-09,
        27: 2.677758127056738e-09,
        28: 3.6247194520011444e-09,
    },
    "Coefficient_P_value": {
        0: 2.2764221753805202e-07,
        1: 5.316667998555866e-07,
        2: 1.195970151769334e-06,
        3: 1.6892144785395035e-06,
        4: 3.051044636973564e-06,
        5: 4.363893870134469e-06,
        6: 6.966567789692105e-06,
        7: 1.289852512519426e-05,
        8: 5.348254527255512e-05,
        9: 0.0001278895071312,
        10: 0.0001751882729846,
        11: 0.0002361259901249,
        12: 0.0002385238366263,
        13: 0.0003098899295538,
        14: 0.000323690810565,
        15: 0.0003923834463395,
        16: 0.0004651120027837,
        17: 0.0006022082857883,
        18: 0.0006641392696964,
        19: 0.0007077903007875,
        20: 0.0007858515216916,
        21: 0.000789917150411,
        22: 0.0008256475384029,
        23: 0.0009520229412011,
        24: 0.0010137630811321,
        25: 0.0011214677539993,
        26: 0.0015628688933578,
        27: 0.0015693910418085,
        28: 0.0015757617047529,
    },
    "_Corrected P Value_": {
        0: 6.647152752111118e-05,
        1: 7.762335277891564e-05,
        2: 0.0001164077614388,
        3: 0.0001233126569333,
        4: 0.0001781810067992,
        5: 0.0002123761683465,
        6: 0.0002906053992271,
        7: 0.0004707961670695,
        8: 0.0017352114688428,
        9: 0.0037343736082315,
        10: 0.0046504523374117,
        11: 0.0053576123303762,
        12: 0.0053576123303762,
        13: 0.0063011811123333,
        14: 0.0063011811123333,
        15: 0.0071609978956973,
        16: 0.0079889826360506,
        17: 0.0097691566361223,
        18: 0.0102067719342816,
        19: 0.0103337383914987,
        20: 0.0104821339658109,
        21: 0.0104821339658109,
        22: 0.0104821339658109,
        23: 0.0115829457846141,
        24: 0.0118407527876238,
        25: 0.0125949455449157,
        26: 0.0158607931150863,
        27: 0.0158607931150863,
        28: 0.0158607931150863,
    },
    "Reject Null": {
        0: True,
        1: True,
        2: True,
        3: True,
        4: True,
        5: True,
        6: True,
        7: True,
        8: True,
        9: True,
        10: True,
        11: True,
        12: True,
        13: True,
        14: True,
        15: True,
        16: True,
        17: True,
        18: False,
        19: False,
        20: False,
        21: False,
        22: False,
        23: False,
        24: False,
        25: False,
        26: False,
        27: False,
        28: False,
    },
    "lower case name": {
        0: "t.4mem.sp",
        1: "nkt.4+.lv",
        2: "nkt.4-.sp",
        3: "t.4mem44h62l.sp",
        4: "ln.tr.14w.b6",
        5: "abd.tr.14w.b6",
        6: "nkt.4-.lv",
        7: "t.4mem44h62l.ln",
        8: "cd4control",
        9: "t.4fp3+25+.sp",
        10: "t.8eff.sp.ot1.d10.lisova",
        11: "tgd.vg2-.sp",
        12: "t.8eff.sp.ot1.d8.vsvova",
        13: "nkt.44+nk1.1+.th",
        14: "tgd.vg2-.act.sp",
        15: "tgd.vg2+.sp",
        16: "nkt.4+.sp",
        17: "nk.b2m-.sp",
        18: "t.4.pa.bdc",
        19: "t.4mem.ln",
        20: "t.8eff.sp.ot1.d8.lisova",
        21: "t.4sp69+.th",
        22: "tgd.vg2+24alo.th",
        23: "tgd.vg2-.sp.tcrbko",
        24: "tgd.vg2+24ahi.th",
        25: "t.8mem.sp.ot1.d45.lisova",
        26: "t.8mem.sp.ot1.d45.vsvova",
        27: "t.8eff.sp.ot1.d15.vsvova",
        28: "t.8mem.sp",
    },
    "Cell Type": {
        0: "T.4Mem.Sp",
        1: "NKT.4+.Lv",
        2: "NKT.4-.Sp",
        3: "T.4Mem44h62l.Sp",
        4: "LN.TR.14w.B6",
        5: "ABD.TR.14w.B6",
        6: "NKT.4-.Lv",
        7: "T.4Mem44h62l.LN",
        8: "CD4Control",
        9: "T.4FP3+25+.Sp",
        10: "T.8Eff.Sp.OT1.d10.LisOva",
        11: "Tgd.vg2-.Sp",
        12: "T.8Eff.Sp.OT1.d8.VSVOva",
        13: "NKT.44+NK1.1+.Th",
        14: "Tgd.vg2-.act.Sp",
        15: "Tgd.vg2+.Sp",
        16: "NKT.4+.Sp",
        17: "NK.b2m-.Sp",
        18: "T.4.Pa.BDC",
        19: "T.4Mem.LN",
        20: "T.8Eff.Sp.OT1.d8.LisOva",
        21: "T.4SP69+.Th",
        22: "Tgd.vg2+24alo.Th",
        23: "Tgd.vg2-.Sp.TCRbko",
        24: "Tgd.vg2+24ahi.Th",
        25: "T.8Mem.Sp.OT1.d45.LisOva",
        26: "T.8Mem.Sp.OT1.d45.VSVOva",
        27: "T.8Eff.Sp.OT1.d15.VSVOva",
        28: "T.8Mem.Sp",
    },
    "Alt Category": {
        0: "Tab",
        1: "Tab",
        2: "Tab",
        3: "Tab",
        4: "Tab",
        5: "Tab",
        6: "Tab",
        7: "Tab",
        8: "Tab",
        9: "Tab",
        10: "Tab",
        11: "Tgd",
        12: "Tab",
        13: "Tab",
        14: "Tgd",
        15: "Tgd",
        16: "Tab",
        17: "Innate_lymphocyte",
        18: "Tab",
        19: "Tab",
        20: "Tab",
        21: "Tab",
        22: "Tgd",
        23: "Tgd",
        24: "Tgd",
        25: "Tab",
        26: "Tab",
        27: "Tab",
        28: "Tab",
    },
    "Category": {
        0: "T",
        1: "NK",
        2: "NK",
        3: "T",
        4: "T",
        5: "T",
        6: "NK",
        7: "T",
        8: "T",
        9: "T",
        10: "T",
        11: "T",
        12: "T",
        13: "NK",
        14: "T",
        15: "T",
        16: "NK",
        17: "NK",
        18: "T",
        19: "T",
        20: "T",
        21: "T",
        22: "T",
        23: "T",
        24: "T",
        25: "T",
        26: "T",
        27: "T",
        28: "T",
    },
}


def test_sldsc_scatter(tmp_path: Path):
    df_loc = tmp_path / "df.csv"
    df = pd.DataFrame(_dummy_data)
    df.to_csv(df_loc, index=False)
    scratch_loc = tmp_path / "scratch"
    scratch_loc.mkdir(exist_ok=True, parents=True)
    task = SLDSCScatterPlotTask(
        meta=SimpleDirectoryMeta("plot_dir"),
        df_source_task=FakeTask(
            SimpleFileMeta(
                "df_source_task",
                read_spec=DataFrameReadSpec(DataFrameTextFormat(separator=",")),
            )
        ),
    )

    def fetch(asset_id: AssetId) -> Asset:
        if asset_id == "df_source_task":
            return FileAsset(df_loc)
        raise ValueError("unknown asset id")

    result = task.execute(scratch_dir=scratch_loc, fetch=fetch, wf=SimpleWF())
    assert isinstance(result, DirectoryAsset)
